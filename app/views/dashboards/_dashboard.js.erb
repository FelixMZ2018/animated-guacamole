document.addEventListener('turbolinks:load', () => {
window.jQuery = $;
window.$ = $;
});

var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
var forecast = <%= JSON.generate(@forecast_hourly).html_safe%>
var index = 0
var outfits = <%= JSON.generate(@outfits).html_safe%>
var avatar = <%= JSON.generate(@user_preferences.avatar_rendering_string).html_safe%>
var warnings = <%= JSON.generate(@warnings).html_safe%>
/// const forecast = document.querySelector('#storageElement');
window.jQuery = $;
window.$ = $;
$( "#avatar_head" ).replaceWith(avatar);
	//	$("#modal-content,#modal-background").toggleClass("active");
// this triggers the rain warning

update()
update_background()
$(function(){
	$("#modal-launcher, #modal-background, #modal-close").click(function () {
		$("#modal-content,#modal-background").toggleClass("active");
	});
});

if ( warnings[0] !== null ) {
		$("#modal-content,#modal-background").toggleClass("active");
}
//`${new Date().getHours()}:${new Date().getMinutes()}`

function update(){
    document.querySelector('.condition').innerText = `${Math.round(forecast[index].temp)}Â°C`;
    document.querySelector('.date').innerText = days[new Date(forecast[index].dt*1000).getDay()] + ' '  + new Date(forecast[index].dt*1000).getDate() +' ' + months[new Date(forecast[index].dt*1000).getMonth()]
    if (index === 0) {
    document.querySelector('.time').innerText = `${new Date().getHours()}:${new Date().getMinutes()}`
    }else{
    document.querySelector('.time').innerText = display_time(new Date(forecast[index].dt*1000).getHours());
    }
    display_time(new Date(forecast[index].dt*1000).getHours())
    document.querySelector('.temp').innerText = `${forecast[index].weather[0].description}`;
    update_clouds();
    update_clouds();
    update_background();
    console.log(forecast[index].condition);
    $( "#Wardrobe_top" ).replaceWith( outfits[forecast[index].condition].top);
    $( "#Wardrobe_bottom" ).replaceWith( outfits[forecast[index].condition].bottom);

}

function update_clouds(){
 if (forecast[index].weather[0].main == "Clouds") {
    document.querySelector('#clouds').style.display = "flex"
 } else {
    document.querySelector('#clouds').style.display = "flex"
 }
 if (forecast[index].weather[0].main == "Rain") {
    document.querySelector('.raincloud').style.display = "none"  // FIX THIS AFTER DEBUGGING 
 } else {
       document.querySelector('.raincloud').style.display = "none"
 }
}
forecast_element = document.querySelector('#dashboard')
forecast_element.addEventListener("touchstart", startTouch, false);
forecast_element.addEventListener("touchmove", moveTouch, false);

// Swipe Up / Down / Left / Right
var initialX = null;
var initialY = null;

function startTouch(e) {
  initialX = e.touches[0].clientX;
  initialY = e.touches[0].clientY;
};

function moveTouch(e) {
  if (initialX === null) {
    return;
  }

  if (initialY === null) {
    return;
  }

  var currentX = e.touches[0].clientX;
  var currentY = e.touches[0].clientY;

  var diffX = initialX - currentX;
  var diffY = initialY - currentY;

  if (Math.abs(diffX) > Math.abs(diffY)) {
    // sliding horizontally
    if (diffX > 0) {
      // swiped left
      //console.log("swiped left");
          if (index + 1 < forecast.length) {
            index = index + 1
    //        console.log(index);
    //console.log(forecast[index])
    update()
    }} else {
      // swiped right
      //console.log("swiped right");
          if (index > 1) {
            index = index - 1
    //console.log(forecast[index])
    update()
    }}}

  initialX = null;
  initialY = null;

  e.preventDefault();
};

function update_background() {
   var hour =  new Date(forecast[index].dt*1000).getHours()
   //console.log(hour);
switch (true) {
  case hour > 23 || hour < 5 :
    document.querySelector('.swiper-box').style.backgroundImage = 'url("<%= asset_path('night.svg') %>")';
       break;
  case hour >= 5 && hour <= 11:
    document.querySelector('.swiper-box').style.backgroundImage = 'url("<%= asset_path('day.svg') %>")';
        break;
  case hour > 11 && hour <= 17:
    document.querySelector('.swiper-box').style.backgroundImage = 'url("<%= asset_path('afternoon.svg') %>")';
    break;
  case hour > 18 && hour <= 23:
    document.querySelector('.swiper-box').style.backgroundImage = 'url("<%= asset_path('evening.svg') %>")';
}
}
function display_time (hour) {
  console.log(hour)
  const period = +hour < 12 ? 'AM' : 'PM'
  if ( hour > 12 ){
  hour = hour - 12
  }
  return( `${hour} ${period}`)
}
